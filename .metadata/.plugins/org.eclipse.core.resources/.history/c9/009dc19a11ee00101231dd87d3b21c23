#include "main.h"
#include "sd_functions.h"
#include "stdio.h"

void sd_create_new_dir(char *path, int year, int month, size_t len)
{
	sd_mount();
	year += 2000;

	// /LOGS
    sd_create_directory("/LOGS");

    // /LOGS/YYYY
    snprintf(path, len, "/LOGS/%04d", year);
    sd_create_directory(path);

    // /LOGS/YYYY/MM
    snprintf(path, len, "/LOGS/%04d/%02d", year, month);
    sd_create_directory(path);

    sd_unmount();
}

void sd_create_new_file(char *path, int date, char* format, size_t len)
{
	snprintf(path + 13, len - 13, "/%02d.%s", date, format);
}

void rtc_task(void* param)
{
	meteo_msg_t msg;
	while(1)
	{
		xTaskNotifyWait(0, 0, NULL, portMAX_DELAY);

		// DS1307
		/*xSemaphoreTake(i2cMutex, portMAX_DELAY);
		if(ds1307_get_current_time(&curr_time) != HAL_OK)
		{
			printf("DS1307_get_time is failed");
		}
		if(ds1307_get_current_date(&curr_date) != HAL_OK)
		{
			printf("DS1307_get_date is failed");
		}
		xSemaphoreGive(i2cMutex);*/

		// RTC
		HAL_RTC_GetTime(&hrtc, sTime, RTC_FORMAT_BIN);

		// Get current value of date, month and year for sd task
		msg.date = curr_date.date;
		msg.month = curr_date.month;
		msg.year = curr_date.year;

		// Write time and date into buffer
		snprintf(msg.timestamp, sizeof(msg.timestamp), "%02d:%02d:%02d%02d.%02d.%02d", curr_time.hours, curr_time.minutes, curr_time.seconds, curr_date.date, curr_date.month, curr_date.year);

		// Send data to bme280 task
		xQueueSend(q_bme280, &msg, portMAX_DELAY);
	}
}

void bme280_task(void* param)
{
	// structure for time, date and measuring
	meteo_msg_t msg;
	while(1)
	{
		xQueueReceive(q_bme280, &msg, portMAX_DELAY);

		xSemaphoreTake(i2cMutex, portMAX_DELAY);
		if(bme280_get_data(&measuring) != HAL_OK)
		{
			printf("DME280_get_data is failed");
		}
		xSemaphoreGive(i2cMutex);

		// Write date into structure
		msg.temperature = (float)measuring.temperature;
		msg.pressure = (float)measuring.pressure;
		msg.humidity = (float)measuring.humidity;

		// Send data to lcd and sd tasks
		xQueueSend(q_lcd, &msg, portMAX_DELAY);
	}
}

extern void lcd_task(void* param)
{
	// structure for time, date and measuring
	meteo_msg_t msg;
	static char meas_buf[17];

	while(1)
	{
		// get data
		xQueueReceive(q_lcd, &msg, portMAX_DELAY);

		snprintf(meas_buf, sizeof(meas_buf), "%02.1f;%03.1f;%02.2f", msg.temperature, msg.pressure, msg.humidity);

		// print data in format
		/* hh:mm:ssdd:mm:yy
		 * tt.t;ppp.p;hh.hh\0
		 */
		lcd_set_cursor(1, 1);
		lcd_print_string(msg.timestamp);

		lcd_set_cursor(2, 1);
		lcd_print_string(meas_buf);

		xQueueSend(q_esp32, &msg, portMAX_DELAY);
	}
}

void esp32(void* param)
{
	meteo_msg_t msg;

	// structure for SPI transmission
	static char rx_dummy_buf[sizeof(measurement_t)];
	measurement_t meas;

	while(1)
	{
		// get data
		xQueueReceive(q_esp32, &msg, portMAX_DELAY);

		meas.temperature = msg.temperature;
		meas.pressure = msg.pressure;
		meas.humidity = msg.humidity;

		xSemaphoreTake(spiMutex, portMAX_DELAY);

		// transmit the measurment
		HAL_SPI_Transmit(&hspi1, (uint8_t*)&meas, sizeof(measurement_t), HAL_MAX_DELAY);

		xSemaphoreGive(spiMutex);

		//xQueueSend(q_sd, &msg, portMAX_DELAY);
	}
}

extern void sd_task(void* param)
{
	// structure for time, date and measuring
	meteo_msg_t msg;
	char sd_file_data[64];
	int32_t time_info_end = 8;

	while(1)
	{
		// get data
		xQueueReceive(q_sd, &msg, portMAX_DELAY);

		// Create new directory if month or year was changed
		if(prev_date.prev_month != msg.month)
		{
			prev_date.prev_month = msg.month;
			sd_create_new_dir(curr_path, msg.year, msg.month, sizeof(curr_path));
		}

		// Create new file if date was changed
		if(prev_date.prev_date != msg.date)
		{
			prev_date.prev_date = msg.date;
			sd_create_new_file(curr_path, msg.date, "csv", sizeof(curr_path));

			// Create title in head of file if you need this
			/*sd_mount();
			sd_append_file(curr_path, "time;temperature;pressure;humidity\r\n");
			sd_unmount();*/
		}

		// Form the buffer for write into file
		/*
		 * hh:mm:ss;tt.t;ppp.p;hh.hh\0
		 */
		snprintf(sd_file_data, time_info_end + 1, "%s", msg.timestamp);
		snprintf(&sd_file_data[time_info_end], sizeof(sd_file_data) - time_info_end, ";%02.1f;%03.1f;%02.2f\r\n",
		         msg.temperature, msg.pressure, msg.humidity);

		// Write data buffer into current file
		sd_mount();
		sd_append_file(curr_path, sd_file_data);
		sd_unmount();
	}
}

